{% extends "base.html" %}

{% block title %}Sensor Dashboard - {{ super() }}{% endblock %}

{% block extra_head %}
<style>
    .sensor-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        transition: transform 0.3s ease;
    }
    
    .sensor-card:hover {
        transform: translateY(-5px);
    }
    
    .sensor-value {
        font-size: 2.5rem;
        font-weight: bold;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    .sensor-unit {
        font-size: 1rem;
        opacity: 0.8;
    }
    
    .chart-container {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
    }
    
    .status-active { background-color: #28a745; }
    .status-error { background-color: #dc3545; }
    .status-unknown { background-color: #6c757d; }
    
    .refresh-btn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 1000;
    }
    
    @media (max-width: 768px) {
        .sensor-value {
            font-size: 1.8rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-4 text-center mb-4">
            <i class="fas fa-chart-line me-3"></i>Sensor Dashboard
        </h1>
        <p class="lead text-center text-muted">Real-time monitoring of your sensor network</p>
    </div>
</div>

<!-- Current Sensor Values -->
<div class="row mb-4" id="sensor-cards">
    <!-- Sensor cards will be populated by JavaScript -->
</div>

<!-- Charts Section -->
<div class="row">
    <!-- Environmental Data Chart -->
    <div class="col-lg-6 mb-4">
        <div class="chart-container">
            <h4 class="text-center mb-3">
                <i class="fas fa-thermometer-half me-2"></i>Environmental Data
                <span class="status-indicator status-unknown" id="bme280-status"></span>
            </h4>
            <canvas id="environmentalChart" height="300"></canvas>
        </div>
    </div>
    
    <!-- Light Level Chart -->
    <div class="col-lg-6 mb-4">
        <div class="chart-container">
            <h4 class="text-center mb-3">
                <i class="fas fa-lightbulb me-2"></i>Light Levels
                <span class="status-indicator status-unknown" id="ltr329-status"></span>
            </h4>
            <canvas id="lightChart" height="300"></canvas>
        </div>
    </div>
    
    <!-- Motion Data Chart -->
    <div class="col-12 mb-4">
        <div class="chart-container">
            <h4 class="text-center mb-3">
                <i class="fas fa-arrows-alt me-2"></i>Motion & Orientation
                <span class="status-indicator status-unknown" id="mpu6050-status"></span>
            </h4>
            <canvas id="motionChart" height="200"></canvas>
        </div>
    </div>
</div>

<!-- System Status -->
<div class="row mb-4">
    <div class="col-12">
        <div class="chart-container">
            <h4 class="text-center mb-3">
                <i class="fas fa-info-circle me-2"></i>System Status
            </h4>
            <div id="system-info" class="row text-center">
                <!-- System info will be populated by JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- Refresh Button -->
<button class="btn btn-primary btn-lg refresh-btn" id="refreshBtn" title="Refresh Data">
    <i class="fas fa-sync-alt"></i>
</button>

<!-- Loading Overlay -->
<div class="position-fixed top-0 start-0 w-100 h-100 d-none justify-content-center align-items-center" 
     style="background: rgba(0,0,0,0.5); z-index: 9999;" id="loadingOverlay">
    <div class="spinner-border text-light" style="width: 3rem; height: 3rem;"></div>
</div>

<script>
// Global variables for charts
let environmentalChart, lightChart, motionChart;
let updateInterval;

// Initialize dashboard when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    loadSensorData();
    startAutoRefresh();
    
    // Refresh button event
    document.getElementById('refreshBtn').addEventListener('click', function() {
        loadSensorData();
        this.classList.add('rotating');
        setTimeout(() => this.classList.remove('rotating'), 1000);
    });
});

function initializeCharts() {
    // Environmental Chart (Temperature, Humidity, Pressure)
    const envCtx = document.getElementById('environmentalChart').getContext('2d');
    environmentalChart = new Chart(envCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Temperature (째C)',
                data: [],
                borderColor: '#ff6384',
                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                tension: 0.4
            }, {
                label: 'Humidity (%)',
                data: [],
                borderColor: '#36a2eb',
                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                tension: 0.4
            }, {
                label: 'Pressure (hPa)',
                data: [],
                borderColor: '#ffce56',
                backgroundColor: 'rgba(255, 206, 86, 0.1)',
                tension: 0.4,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Temperature (째C) / Humidity (%)'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Pressure (hPa)'
                    },
                    grid: {
                        drawOnChartArea: false,
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            }
        }
    });
    
    // Light Chart
    const lightCtx = document.getElementById('lightChart').getContext('2d');
    lightChart = new Chart(lightCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Ambient Light',
                data: [],
                borderColor: '#ffce56',
                backgroundColor: 'rgba(255, 206, 86, 0.2)',
                fill: true,
                tension: 0.4
            }, {
                label: 'IR Light',
                data: [],
                borderColor: '#ff6384',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Light Level'
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            }
        }
    });
    
    // Motion Chart (Accelerometer and Gyroscope)
    const motionCtx = document.getElementById('motionChart').getContext('2d');
    motionChart = new Chart(motionCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Accel X (g)',
                data: [],
                borderColor: '#ff6384',
                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                tension: 0.4
            }, {
                label: 'Accel Y (g)',
                data: [],
                borderColor: '#36a2eb',
                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                tension: 0.4
            }, {
                label: 'Accel Z (g)',
                data: [],
                borderColor: '#ffce56',
                backgroundColor: 'rgba(255, 206, 86, 0.1)',
                tension: 0.4
            }, {
                label: 'Gyro X (째/s)',
                data: [],
                borderColor: '#4bc0c0',
                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                tension: 0.4,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Acceleration (g)'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Angular Velocity (째/s)'
                    },
                    grid: {
                        drawOnChartArea: false,
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            }
        }
    });
}

function loadSensorData() {
    showLoading(true);
    
    fetch('/api/sensors/current')
        .then(response => response.json())
        .then(data => {
            updateSensorCards(data);
            updateCharts(data);
            updateSystemStatus(data);
            showLoading(false);
        })
        .catch(error => {
            console.error('Error fetching sensor data:', error);
            showLoading(false);
        });
}

function updateSensorCards(data) {
    const cardsContainer = document.getElementById('sensor-cards');
    cardsContainer.innerHTML = '';
    
    data.sensors.forEach(sensor => {
        const card = createSensorCard(sensor);
        cardsContainer.appendChild(card);
    });
}

function createSensorCard(sensor) {
    const col = document.createElement('div');
    col.className = 'col-lg-4 col-md-6 mb-3';
    
    const statusClass = sensor.status === 'active' ? 'status-active' : 
                       sensor.status === 'error' ? 'status-error' : 'status-unknown';
    
    let cardContent = '';
    
    if (sensor.sensor_type === 'bme280') {
        const data = sensor.latest_reading?.data || {};
        cardContent = `
            <div class="sensor-card p-4 h-100">
                <h5><i class="fas fa-thermometer-half me-2"></i>Environmental</h5>
                <div class="sensor-value">${data.temperature?.toFixed(1) || '--'}째C</div>
                <div class="row mt-2">
                    <div class="col-6">Humidity: ${data.humidity?.toFixed(1) || '--'}%</div>
                    <div class="col-6">Pressure: ${data.pressure?.toFixed(0) || '--'} hPa</div>
                </div>
                <div class="mt-2">
                    <span class="status-indicator ${statusClass}"></span>
                    ${sensor.sensor_id}
                </div>
            </div>
        `;
    } else if (sensor.sensor_type === 'ltr329') {
        cardContent = `
            <div class="sensor-card p-4 h-100">
                <h5><i class="fas fa-lightbulb me-2"></i>Light Sensor</h5>
                <div class="sensor-value">${sensor.latest_reading?.light_level?.toFixed(1) || '--'}</div>
                <div class="sensor-unit">lux</div>
                <div class="mt-2">IR: ${sensor.latest_reading?.ir_level?.toFixed(1) || '--'}</div>
                <div class="mt-2">
                    <span class="status-indicator ${statusClass}"></span>
                    ${sensor.sensor_id}
                </div>
            </div>
        `;
    } else if (sensor.sensor_type === 'mpu6050') {
        const accelMagnitude = sensor.latest_reading ? 
            Math.sqrt(
                Math.pow(sensor.latest_reading.accel_x || 0, 2) +
                Math.pow(sensor.latest_reading.accel_y || 0, 2) +
                Math.pow(sensor.latest_reading.accel_z || 0, 2)
            ) : 0;
        
        cardContent = `
            <div class="sensor-card p-4 h-100">
                <h5><i class="fas fa-arrows-alt me-2"></i>Motion Sensor</h5>
                <div class="sensor-value">${accelMagnitude.toFixed(2)}g</div>
                <div class="sensor-unit">total acceleration</div>
                <div class="mt-2">Temp: ${sensor.latest_reading?.temperature?.toFixed(1) || '--'}째C</div>
                <div class="mt-2">
                    <span class="status-indicator ${statusClass}"></span>
                    ${sensor.sensor_id}
                </div>
            </div>
        `;
    }
    
    col.innerHTML = cardContent;
    return col;
}

function updateCharts(data) {
    const timestamp = new Date().toLocaleTimeString();
    
    data.sensors.forEach(sensor => {
        updateSensorStatus(sensor.sensor_type, sensor.status);
        
        if (sensor.sensor_type === 'bme280' && sensor.latest_reading?.data) {
            const envData = sensor.latest_reading.data;
            addDataToChart(environmentalChart, timestamp, [
                envData.temperature,
                envData.humidity,
                envData.pressure
            ]);
        }
        
        if (sensor.sensor_type === 'ltr329' && sensor.latest_reading) {
            addDataToChart(lightChart, timestamp, [
                sensor.latest_reading.light_level,
                sensor.latest_reading.ir_level
            ]);
        }
        
        if (sensor.sensor_type === 'mpu6050' && sensor.latest_reading) {
            addDataToChart(motionChart, timestamp, [
                sensor.latest_reading.accel_x,
                sensor.latest_reading.accel_y,
                sensor.latest_reading.accel_z,
                sensor.latest_reading.gyro_x
            ]);
        }
    });
}

function addDataToChart(chart, label, dataPoints) {
    chart.data.labels.push(label);
    
    dataPoints.forEach((value, index) => {
        if (chart.data.datasets[index]) {
            chart.data.datasets[index].data.push(value);
        }
    });
    
    // Keep only last 20 data points
    const maxPoints = 20;
    if (chart.data.labels.length > maxPoints) {
        chart.data.labels.shift();
        chart.data.datasets.forEach(dataset => {
            dataset.data.shift();
        });
    }
    
    chart.update('none');
}

function updateSensorStatus(sensorType, status) {
    const statusElement = document.getElementById(`${sensorType}-status`);
    if (statusElement) {
        statusElement.className = `status-indicator status-${status}`;
    }
}

function updateSystemStatus(data) {
    const systemInfo = document.getElementById('system-info');
    systemInfo.innerHTML = `
        <div class="col-md-3">
            <h6>Total Sensors</h6>
            <div class="h4">${data.sensors.length}</div>
        </div>
        <div class="col-md-3">
            <h6>Active Sensors</h6>
            <div class="h4 text-success">${data.sensors.filter(s => s.status === 'active').length}</div>
        </div>
        <div class="col-md-3">
            <h6>Last Update</h6>
            <div class="h6">${new Date().toLocaleTimeString()}</div>
        </div>
        <div class="col-md-3">
            <h6>System Status</h6>
            <div class="h6 text-success">Online</div>
        </div>
    `;
}

function startAutoRefresh() {
    updateInterval = setInterval(loadSensorData, 5000); // Refresh every 5 seconds
}

function showLoading(show) {
    const overlay = document.getElementById('loadingOverlay');
    overlay.classList.toggle('d-none', !show);
    overlay.classList.toggle('d-flex', show);
}

// Add rotation animation for refresh button
document.head.insertAdjacentHTML('beforeend', `
    <style>
        .rotating {
            animation: spin 1s linear;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
`);

// Clean up interval when page unloads
window.addEventListener('beforeunload', function() {
    if (updateInterval) {
        clearInterval(updateInterval);
    }
});
</script>
{% endblock %}